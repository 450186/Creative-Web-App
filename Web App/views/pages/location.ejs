<%- include("../partials/header") %>
    
    <h3 style="text-align: center;"> <%= city %> </h3>
<% if (!locationFound) { %>
     <form action="<%= inWishlist ? '/remove-wishlist' : 'add-wishlist' %>" method="POST">
        <input type="hidden" name="city" value="<%= city || "" %>">
        <input type="hidden" name="country" value="<%= country %>">
        <input type="hidden" name="longitude" value="<%= longitude %>">
        <input type="hidden" name="latitude" value="<%= latitude %>">
        <input type="hidden" name="countryCode" value="<%= countryCode %>">
        <label for="wishlist-check"><%= inWishlist ? "Remove from Wishlist" : "Add to Wishlist" %></label>
        <input 
        name="wishlist" 
        onchange="this.form.submit()" 
        type="checkbox" 
        id="wishlist-check" 
        <%= inWishlist ? "checked" : "" %>
        >
    </form>
    <h2 style="text-align: center; margin-bottom: 0px;">Visited here before?</h2>
    <div style="text-align: center; margin-top: 0px; margin-bottom: 10px;">
        <input type="radio" name="visited" value="Yes" id="yes-radio">
        <label for="Yes">Yes</label>
        <input type="radio" name="visited" value="No" id="no-radio" checked>
        <label for="No">No</label>
    </div>
    <% if (typeof errorMessage !== 'undefined') { %>
        <p id="errorMessage"><%= errorMessage %></p>
    <% } %>
    <form id="location-form" 
    method="POST" 
    style="padding-top: 10px; display: none;" 
    action="add-location"
    >
        <input type="hidden" name="city" value="<%= city || "" %>">
        <input type="hidden" name="country" value="<%= country %>">
        <input type="hidden" name="countryCode" value="<%= countryCode %>">
        <input type="hidden" name="longitude" value="<%= longitude %>">
        <input type="hidden" name="latitude" value="<%= latitude %>">
        <label for="visit-date">When did you visit?</label>
        <div id="date-select">
            <input type="date" id="visit-date-start" name="visitDateStart">
            <label for="to-date">To:</label>
            <input type="date" id="visit-date-end" name="visitDateEnd">
        </div>
        <label for="photos">Photos:</label>
        <input type="file" id="photos-upload" name="photos" multiple><br>
        <div id="notes-div">
            <label style="vertical-align: baseline;" for="notes">Notes:</label>
            <textarea id="notes" name="notes" rows="4" cols="25"></textarea><br>            
        </div>
<br>
        <label for="rating">Rating:</label>
        <select id="rating" name="rating">
            <option value="1">1⭐️</option>
            <option value="2">2⭐️</option>
            <option value="3">3⭐️</option>
            <option value="4">4⭐️</option>
            <option value="5">5⭐️</option>
        </select><br>
        <input style="margin-top: 10px;" type="submit" value="Add to History">
    </form>
<% } %>
<% if (locationFound) { %>
    <div id="location-div">
        <h2><%= visitedData.country %></h2>
        <h3><%= visitedData.city %></h3>
        <hr style="width: 100%;">
        <p style="margin-bottom: 0;"><%= visitedData.formattedStart %></p>
        <p style="margin-bottom: 0; font-weight: bold;"> to </p>
        <p style="margin-bottom: 0;"><%= visitedData.formattedEnd %></p>
        <p style="font-weight: bold; margin-bottom: 0;">Thoughts:</p>
        <p style="margin-bottom: 0;"><%= visitedData.notes %></p>
        <p style="font-weight: bold; margin-bottom: 0;">Rating:</p>
        <p><%= visitedData.rating %></p>
    </div> 
<% } %>
    <div id="things-to-do-div">
        <h2 style="text-align: center; margin-bottom: 10px; margin-top: 20px;">Things to do around <%= city %>:</h2>

        <div class="slideshow-container">
            <p style="padding: 20px;" id="errorMessage">Loading...</p> 
        </div>
        
 
</div>
<script>
    const latitude = "<%= latitude %>";
    const longitude = "<%= longitude %>";

    fetch(`/api/things-to-do?latitude=${latitude}&longitude=${longitude}`)
    .then(res => res.json())
    .then(data => {
        const container = document.getElementsByClassName("slideshow-container")[0];
        const thingsToDo = data.thingsToDo;
        if(!thingsToDo || thingsToDo.length === 0) {
            container.innerHTML = "<p id='errorMessage'>No things to do in this area.</p>";
            return;
        }
        container.innerHTML = `<a class="prev" onclick="plusSlides(-1)">&#10094;</a>
            <a class="next" onclick="plusSlides(1)">&#10095;</a>`;

        thingsToDo.forEach(item => {
            const slideDiv = document.createElement("div");
            slideDiv.classList.add("fact-slides");
            const title = document.createElement("h3");
            title.textContent = item.name;
            slideDiv.appendChild(title);
            if(item.address) {
                const address = document.createElement("p");
                address.textContent = item.address;
                slideDiv.appendChild(address);
            }
            if(item.distance) {
                const distance = document.createElement("p");
                distance.textContent = `Distance: ${item.distance.toFixed(2)} m`;
                slideDiv.appendChild(distance);
            }
            if(item.category && item.category.length > 0) {
                const categoryArray = item.category.split("\n");
                const categories = document.createElement("p");
                categories.textContent = `Categories: ${categoryArray.join(", \n")}`;
                slideDiv.appendChild(categories);
            }
            container.appendChild(slideDiv);
            console.log(`Name: ${item.name}`)
            console.log(`categories: ${item.category}`);
            console.log(item)
        })
        slideIndex = 1;
        showSlides(slideIndex);
    })
</script>

    <script defer>
        let yesRadio = document.getElementById("yes-radio")
        let noRadio = document.getElementById("no-radio")
        let locationForm = document.getElementById("location-form")
        yesRadio.addEventListener("change", () => {
            if(yesRadio.checked) {
                locationForm.style.display = "block"
            } 
        })
        noRadio.addEventListener("change", () => {
            if(noRadio.checked) {
                locationForm.style.display = "none"
            }
        })
        
        let slideIndex = 1;
        showSlides(slideIndex);

        function plusSlides(n) {
            showSlides(slideIndex += n);
        }
        function showSlides(n) {
            let i;
            let slides = document.getElementsByClassName('fact-slides');

            if(slides.length === 0) {
                return;
            }

            if(n > slides.length) {slideIndex = 1}
            if(n < 1) {slideIndex = slides.length}

            for(i=0; i < slides.length; i++) {
                slides[i].style.display = "none";
            }
            slides[slideIndex - 1].style.display = "block"
        }


    </script>
<%- include("../partials/footer") %>